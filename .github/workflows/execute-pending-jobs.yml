# Cron: trigger execution of pending jobs on the live API (Neon + Render, no paid worker).
# Runs every 5 minutes. Set GitHub repo secret CRON_SECRET and repo variable API_URL (your live API base URL).
name: Execute pending jobs

on:
  schedule:
    # Every 5 minutes (GitHub Actions limit: shortest is 5 min for scheduled runs)
    - cron: '*/5 * * * *'
  workflow_dispatch: # Allow manual run from Actions tab

jobs:
  trigger:
    runs-on: ubuntu-latest
    steps:
      - name: Call execute-pending-jobs
        env:
          API_URL: ${{ vars.API_URL }}
          CRON_SECRET: ${{ secrets.CRON_SECRET }}
        run: |
          API_URL="${API_URL}"
          if [ -z "$API_URL" ]; then echo "::error::Set API_URL (repo variable or env) to your live API base URL."; exit 1; fi
          if [ -z "$CRON_SECRET" ]; then
            echo "::warning::CRON_SECRET not set. Add it in repo Settings → Secrets and variables → Actions."
            exit 0
          fi
          # Render free tier can cold-start in ~50s; use long timeout and retry so cron succeeds
          for attempt in 1 2; do
            if [ "$attempt" -eq 2 ]; then
              echo "Cold start? Waiting 55s then retrying..."
              sleep 55
            fi
            resp=$(curl -s -w "\n%{http_code}" --max-time 90 -X POST \
              "$API_URL/api/cron/execute-pending-jobs" \
              -H "X-Cron-Secret: $CRON_SECRET" \
              -H "Content-Type: application/json") || true
            code=$(echo "$resp" | tail -n1)
            body=$(echo "$resp" | sed '$d')
            echo "Response ($code): $body"
            if [ "$code" = "200" ] || [ "$code" = "201" ]; then
              echo "Jobs processed. ok=true"
              exit 0
            fi
            if [ "$code" = "401" ]; then
              echo "::error::Invalid CRON_SECRET. Ensure Render env CRON_SECRET matches GitHub secret."
              exit 1
            fi
            if [ "$code" = "503" ]; then
              echo "::warning::Cron not configured on API (CRON_SECRET not set in Render)."
              exit 0
            fi
            if [ "$code" != "000" ] && [ -n "$code" ]; then
              echo "::error::Request failed with $code"
              exit 1
            fi
          done
          echo "::error::Request timed out (Render may be cold). Run workflow again or check Render logs."
          exit 1
